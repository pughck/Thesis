package edu.rosehulman.pughck;

import org.apache.storm.hdfs.bolt.HdfsBolt;
import org.apache.storm.hdfs.bolt.rotation.NoRotationPolicy;
import org.apache.storm.hdfs.bolt.sync.CountSyncPolicy;

import backtype.storm.Config;
import backtype.storm.StormSubmitter;
import backtype.storm.topology.TopologyBuilder;
import backtype.storm.topology.base.BaseRichSpout;
import backtype.storm.tuple.Fields;

public class ClusterTopology {

	public static void main(String[] args) throws Exception {

		Config conf = new Config();
		conf.setNumWorkers(1);
		conf.setMaxSpoutPending(5000);

		TopologyBuilder builder = new TopologyBuilder();

		BaseRichSpout spout = new TweetSpout("OgHA59vKcpBKqr92QsVyhGswD",
				"nWComrkhNlHYKVE2SjCb2D1roLzNog1NNDEh5s98c9i6KJJ6XT",
				"4041041357-rkWibnDMhQSwJD1g5iOCsJae2J56Ni4XGbbOVe9", "XaDM2EVfh3om2uWsUD6sWVCeOERFgyDqHQAb6FfwSUUix");

		HdfsBolt bolt = new HdfsBolt().withFsUrl("hdfs://hadoop-ckp-1.csse.rose-hulman.edu:8020")
				.withRecordFormat(new ClusterRecordFormat()).withFileNameFormat(new ClusterFileNameFormat())
				.withSyncPolicy(new CountSyncPolicy(1000)).withRotationPolicy(new NoRotationPolicy());

		builder.setSpout("tweetSpout", spout, 1);
		builder.setBolt("clusterBolt", bolt, 1).fieldsGrouping("tweetSpout", new Fields("company"));

		StormSubmitter.submitTopology("cluster2", conf, builder.createTopology());
	}
}
